name: Cloud check in action

on:
  workflow_dispatch:
  schedule:
    - cron: '0 8 * * *'

jobs:
  generate-random-times:
    runs-on: ubuntu-latest
    outputs:
      first-time: ${{ steps.generate.outputs.first-time }}
      second-time: ${{ steps.generate.outputs.second-time }}
    steps:
      - name: Generate two random times
        id: generate
        run: |
          # ç”Ÿæˆ 8 ç‚¹åˆ° 10 ç‚¹ä¹‹é—´çš„ä¸¤ä¸ªéšæœºåˆ†é’Ÿ
          FIRST_MINUTE=$(shuf -i 0-119 -n 1)
          SECOND_MINUTE=$(shuf -i 0-119 -n 1)
          # ç¡®ä¿ä¸¤ä¸ªæ—¶é—´ä¸åŒ
          while [ "$FIRST_MINUTE" -eq "$SECOND_MINUTE" ]; do
            SECOND_MINUTE=$(shuf -i 0-119 -n 1)
          done
          # å°†åˆ†é’Ÿè½¬æ¢ä¸ºå°æ—¶å’Œåˆ†é’Ÿæ ¼å¼
          FIRST_HOUR=$((8 + FIRST_MINUTE / 60))
          FIRST_MINUTE=$((FIRST_MINUTE % 60))
          SECOND_HOUR=$((8 + SECOND_MINUTE / 60))
          SECOND_MINUTE=$((SECOND_MINUTE % 60))
          # è¾“å‡ºç»“æžœ
          echo "first-time=$FIRST_HOUR:$FIRST_MINUTE" >> $GITHUB_OUTPUT
          echo "second-time=$SECOND_HOUR:$SECOND_MINUTE" >> $GITHUB_OUTPUT

  first-run:
    needs: generate-random-times
    runs-on: ubuntu-latest
    steps:
      - name: Wait for the first random time
        run: |
          CURRENT_TIME=$(date +%s)
          TARGET_TIME=$(date -d "${{ needs.generate-random-times.outputs.first-time }}" +%s)
          if [ $TARGET_TIME -lt $CURRENT_TIME ]; then
            TARGET_TIME=$((TARGET_TIME + 86400))
          fi
          WAIT_TIME=$((TARGET_TIME - CURRENT_TIME))
          sleep $WAIT_TIME
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Run the first task
        run: echo "This is the first randomly scheduled task running between 8 - 10 AM."

  second-run:
    needs: generate-random-times
    runs-on: ubuntu-latest
    steps:
      - name: Wait for the second random time
        run: |
          CURRENT_TIME=$(date +%s)
          TARGET_TIME=$(date -d "${{ needs.generate-random-times.outputs.second-time }}" +%s)
          if [ $TARGET_TIME -lt $CURRENT_TIME ]; then
            TARGET_TIME=$((TARGET_TIME + 86400))
          fi
          WAIT_TIME=$((TARGET_TIME - CURRENT_TIME))
          sleep $WAIT_TIME
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Run the second task
        run: echo "This is the second randomly scheduled task running between 8 - 10 AM."
    
      - name: ðŸŽ‰ Delete old workflow run
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 50
