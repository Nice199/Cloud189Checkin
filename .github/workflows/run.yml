name: Cloud check in action

on:
  workflow_dispatch:
  schedule:
    - cron: '0 23 * * *' # UTC æ—¶é—´ 23:00 å¯¹åº”åŒ—äº¬æ—¶é—´ 7:00

concurrency:
  group: cloud-check-in-action
  cancel-in-progress: true

jobs:
  generate-random-times:
    runs-on: ubuntu-latest
    outputs:
      first-time: ${{ steps.generate.outputs.first-time }}
      second-time: ${{ steps.generate.outputs.second-time }}
    steps:
      - name: Generate two random times
        id: generate
        run: |
          echo "Generating random times..."
          RANDOM_MINUTES=$(shuf -i 0-119 -n 2 | sort -n)
          FIRST_MINUTE=$(echo $RANDOM_MINUTES | cut -d' ' -f1)
          SECOND_MINUTE=$(echo $RANDOM_MINUTES | cut -d' ' -f2)
          FIRST_HOUR=$((8 + FIRST_MINUTE / 60))
          FIRST_MINUTE=$((FIRST_MINUTE % 60))
          SECOND_HOUR=$((8 + SECOND_MINUTE / 60))
          SECOND_MINUTE=$((SECOND_MINUTE % 60))
          FIRST_TIME=$(printf "%02d:%02d" $FIRST_HOUR $FIRST_MINUTE)
          SECOND_TIME=$(printf "%02d:%02d" $SECOND_HOUR $SECOND_MINUTE)
          echo "First time: $FIRST_TIME"
          echo "Second time: $SECOND_TIME"
          echo "first-time=$FIRST_TIME" >> $GITHUB_OUTPUT
          echo "second-time=$SECOND_TIME" >> $GITHUB_OUTPUT

  first-run:
    needs: generate-random-times
    runs-on: ubuntu-latest
    steps:
      - name: Wait for the first random time
        run: |
          export TZ=Asia/Shanghai
          echo "Waiting for first random time: ${{ needs.generate-random-times.outputs.first-time }}"
          CURRENT_TIME=$(date +%s)
          TARGET_TIME=$(date -d "${{ needs.generate-random-times.outputs.first-time }}" +%s || exit 1)
          if [ $TARGET_TIME -lt $CURRENT_TIME ]; then
            TARGET_TIME=$((TARGET_TIME + 86400))
          fi
          WAIT_TIME=$((TARGET_TIME - CURRENT_TIME))
          echo "Sleeping for $WAIT_TIME seconds."
          sleep $WAIT_TIME
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Run the first task
        run: |
          echo "Running the first task..."
          echo "This is the first randomly scheduled task running between 8 - 10 AM."

  second-run:
    needs: generate-random-times
    runs-on: ubuntu-latest
    steps:
      - name: Wait for the second random time
        run: |
          export TZ=Asia/Shanghai
          echo "Waiting for second random time: ${{ needs.generate-random-times.outputs.second-time }}"
          CURRENT_TIME=$(date +%s)
          TARGET_TIME=$(date -d "${{ needs.generate-random-times.outputs.second-time }}" +%s || exit 1)
          if [ $TARGET_TIME -lt $CURRENT_TIME ]; then
            TARGET_TIME=$((TARGET_TIME + 86400))
          fi
          WAIT_TIME=$((TARGET_TIME - CURRENT_TIME))
          echo "Sleeping for $WAIT_TIME seconds."
          sleep $WAIT_TIME
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Run the second task
        run: |
          echo "Running the second task..."
          echo "This is the second randomly scheduled task running between 8 - 10 AM."
      - name: ðŸŽ‰ Delete old workflow runs
        uses: Mattraks/delete-workflow-runs@main
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 30
          keep_minimum_runs: 10